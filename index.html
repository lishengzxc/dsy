<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>æˆ‘çš„ç¦å¡</title>
</head>
<style>
        *{
            margin: 0;
            padding: 0;
        }
        html {
            height: 100%;
        }
        body {
            height: 100%;
            background-image: url(https://gw.alicdn.com/tfs/TB1FEzIFmzqK1RjSZFjXXblCFXa-306-466.png);
            background-repeat: no-repeat;
            background-size: 100% auto;
            background-position: center 0;
            background-color: rgb(31, 31, 55);
        }
        .box{
            left: calc(50% - 61.25000000000001vw / 2);
            position: absolute;
            width: 61.25000000000001vw;
            top: 84vw;
            height: 35vw;
        }
        #canvas{
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
            width: 61.25000000000001vw;
            height: 35vw;
        }
        .bk{
            display: -webkit-flex;
            -webkit-justify-content: center;
            -webkit-align-items: center;
            width: 61.25000000000001vw;
            height: 35vw;
            background: #fff;
            position: absolute;
            /* top: 0;
            left: 0; */
            text-align: center;
        }
        #freshBtn{
            margin-left: 100px;
            user-select: none;
            background: #ddd;
            width: 80px;
            height: 40px;
            text-align: center;
            line-height: 40px;
        }
    </style>
<body>
    <div class="box">
        <div class="bk">
            åŸå‘³ğŸŒ¸é…±æ–°å¹´å¿«ä¹ï¼
        </div>
        <canvas id="canvas"></canvas>
    </div>
    <!-- <div id="freshBtn">é‡ç½®</div> -->
</body>
<script>
class canvasClass {
    constructor (id,text,cover,coverType,width,height,drawPercentCallback) {
        this.conId = id; /*canvasID */
        this.conNode = document.getElementById(this.conId);
        this.ctx = this.conNode.getContext('2d');
        this.coverText = text;
        this.cover = cover; /**å›¾å±‚é¢œè‰²æˆ–å›¾ç‰‡ */
        this.coverType = coverType; /**å›¾å±‚ç±»å‹ï¼ˆimage/colorï¼‰ */
        this.width = width;
        this.height = height;
        this.drawPercentCallback = drawPercentCallback
        this.clientRect = null;
        this.isMouseDown = false;
    }
    /**
     * ç»˜åˆ¶canvas
     */
    fillCanvas () {
        this.conNode.setAttribute('width', this.width);
        this.conNode.setAttribute('height', this.height);
        if (this.coverType == 'color') {
            this.ctx.save();
            this.ctx.fillStyle = this.cover;
            this.ctx.fillRect(0, 0, this.width, this.height);
            this.ctx.restore();
            this.ctx.save();
            var fontSize = 30;
            this.ctx.font = '30px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillStyle = '#fff';
            this.ctx.fillText(this.coverText, this.width/2, this.height/2+fontSize/2);
            this.ctx.restore();
            this.ctx.globalCompositeOperation = 'destination-out';
        } else if (this.coverType == 'image') {
            var image = new Image(this.width, this.height)
            image.onload = () => {
                this.ctx.drawImage(image, 0, 0, this.width, this.height);
            }
            image.src = this.cover;
        }
        this.clientRect = this.conNode ? this.conNode.getBoundingClientRect() : null
    }
    /**
     * äº‹ä»¶ç›‘å¬
     */
    bindEvent () {
        /**ç§»åŠ¨ç«¯æ£€æµ‹ */
        var device = (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()));
        var clickEvt = device ? 'touchstart' : 'mousedown';
        var moveEvt = device ? 'touchmove' : 'mousemove';
        var x1,y1,x2,y2;
        
        // if (!device) {
        //     document.addEventListener('mouseup', (e) => {
        //         this.isMouseDown = false;
        //     })
        // } else {
        //     document.addEventListener("touchmove", (e) => {
        //         if (this.isMouseDown) {
        //             e.preventDefault();
        //         }
        //     })
        //     document.addEventListener("touchend", (e) => {
        //         this.isMouseDown = false;
        //     })
        // }
        /**æ·»åŠ ç›‘å¬ */
        this.conNode.addEventListener(clickEvt, (e) => {
            console.log(e);
            this.isMouseDown = true;
            x1 = device ? e.touches[0].pageX : e.offsetX;
            y1 = device ? e.touches[0].pageY : e.offsetY;
            x1  = x1 - (document.documentElement.clientWidth * 0.2);
            y1 = y1 - (document.documentElement.clientWidth * 0.8375);
            this.drawPoint(x1, y1)
        })
        this.conNode.addEventListener(moveEvt, (e) => {
            if (!device && !this.isMouseDown) {
                return false;
            }
            this.isMouseDown = true;
            x2 = device ? e.touches[0].pageX : e.offsetX;
            y2 = device ? e.touches[0].pageY : e.offsetY;
            x2  = x2 - document.documentElement.clientWidth * 0.2;
            y2 = y2 - document.documentElement.clientWidth * 0.8375;
            this.drawPoint(x1, y1, x2, y2)
            // console.log(x1,x2,y1,y2)
            x1 = x2
            y1 = y2
            // [x1, y1] = [x2, y2]
        })
    }
    /**
     * æŠ¹å»ï¼Œ è¿”å›ç™¾åˆ†æ¯”
     */
    drawPoint (x1, y1, x2, y2) {
        
        var bar = 20; // åŠå¾„
        this.ctx.beginPath();
        if (x2) {
            /**
             * ä¼˜åŒ–ç»˜åˆ¶è·¯å¾„
             */
            var asin = bar*Math.sin(Math.atan((y2-y1)/(x2-x1)));
            var acos = bar*Math.cos(Math.atan((y2-y1)/(x2-x1)))
            var x3 = x1+asin;
            var y3 = y1-acos;
            var x4 = x1-asin;
            var y4 = y1+acos;
            var x5 = x2+asin;
            var y5 = y2-acos;
            var x6 = x2-asin;
            var y6 = y2+acos;
            this.ctx.save();
            this.ctx.beginPath();
            this.ctx.moveTo(x3,y3);
            this.ctx.lineTo(x5,y5);
            this.ctx.lineTo(x6,y6);
            this.ctx.lineTo(x4,y4);
            this.ctx.closePath();
            this.ctx.clip();
            this.ctx.clearRect(0,0,this.width,this.height);
            this.ctx.restore();
            this.ctx.arc(x2, y2, bar, 0, Math.PI*2, true);
        } else {
            this.ctx.arc(x1, y1, bar, 0, Math.PI*2, true);
        }
        this.ctx.fill();
        if (this.drawPercentCallback) {
            this.drawPercentCallback(this.getTransparentPercent());
        }
    }

    getTransparentPercent () {
        var imgData = this.ctx.getImageData(0, 0, this.width, this.height),
            pixles = imgData.data,
            transPixs = [];
        for (var i = 0, j = pixles.length; i < j; i += 4) {
            var a = pixles[i + 3];
            if (a < 128) {
                transPixs.push(i);
            }
        }
        return (transPixs.length / (pixles.length / 4) * 100).toFixed(2);
    }

}

function canvasInit(json) {
    var arr = []
    for (let item in json) {
        arr.push(json[item])
    }
    this.init = new canvasClass(...arr)
    this.init.fillCanvas()
    this.init.bindEvent()

    // var btn = document.querySelector('#freshBtn');
    // btn.addEventListener('click', (e) => {
    //     this.init.fillCanvas()
    // });

}

canvasInit.prototype.fresh = function () {
    console.log(this.init)
    this.init.fillCanvas()
    this.init.isMouseDown = false
}
</script>
<script>
    var canvas = new canvasInit({
        id: 'canvas',
        text: 'åˆ®å¼€æŠ½å¥–',
        cover: '#1f1f1f',
        coverType: 'color',
        width: 300,
        height: 180,
        drawPercentCallback: (num) => {
            // if(num > 30) {
            //     alert('æ­å–œè·å¾—ä¸€ç­‰å¥–')
            //     canvas.fresh() // é‡ç½®
            // }
        }
    })
</script>
</html>
